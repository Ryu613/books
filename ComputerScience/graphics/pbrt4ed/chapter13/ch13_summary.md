# 第13章重点总结

此章主要讲解了光传播方程及路径追踪的理论与实现

## 光传播方程(LTE)的推导

用来描述表面某点的总辐射量，由于能量守恒，我们可知，某点的总出射辐射量，等于入射辐射量加上自己发出的辐射量，即可得LTE(也叫渲染方程):

$$
 L_o(p, \omega_o) = L_e(p, \omega_o) + \int_{S^2}f(p, \omega_o,\omega_i)L_i(p,\omega_i)|\cos \theta_i|d\omega_i
$$

式子中有两个量需要给出$L_e$(自身辐射量)和$L_i$(入射光辐射量)，根据能量守恒可知，某点在$\omega_i$方向上的入射光辐射量，就是此方向的某交点在$-\omega_i$方向上的出射光辐射量，若没有此交点，则入射光辐射量为0。

上式中的$L_i$,就可以用$L_e$代替。

我们把这个交点设为p',用$t(p,\omega)$代表p点转换为p'点的函数,则原LTE就可以写成:

$$
 L(p, \omega_o) = L_e(p, \omega_o) + \int_{S^2}f(p, \omega_o,\omega_i)L(t(p, \omega), -\omega_i)|\cos \theta_i|d\omega_i
$$

这个式子把L的下标去掉了，原本的$L_i$是求p点在$\omega_i$方向上的入射光辐射量，改为了p'点(即$t(p, \omega)$)在反方向上的出射辐射量。这样修改的好处，即我们只需考虑$L_e$，而后续光传播路径上的入射光辐射量，都可以通过一系列出射光辐射量替代

我们要求某点打到相机的辐射量，即求所有从光源开始，通过各种物体散射路径，最终落到相机的光辐射量的总和

可以用下式表示:

$$
L(p_1 \rightarrow p_0) = \sum_{n=1}^{\infty}P(\bar{p_n})
$$

$P(\bar{p_n})$是指路径长度为n的光线路径(有n+1个顶点)里，按照LTE递归以后拆出来的式子，带有积分的那一项，$P(\bar{p_n})$就是带着n-1次积分的那个式子，$T(\bar{p_n})$代表$P(\bar{p_n})$里面滚雪球一样带着的BSDF乘以G函数的累积值，称作吞吐量

利用蒙特卡洛估计法，就可以得到:

$$
L(p_1 \rightarrow p_0) \approx \sum_{n=1}^{\infty}\frac{P(\bar{p_n})}{p(\bar{p_n})}
$$

分母里的$p(\bar{p_n})$,代表从$p_n$到$p_{n-1}$点的一小段路径的概率密度

这个式子就是说，我们要求得p1到相机点p0的辐射量，先定义个路径长度n, 从pn(光源)到p0(相机)之间，选每一小段可能的路径，可得那段路径的估计值，把估计值用对应PDF加权再整体求和，就得到整条光路的估计值

## 两个问题的解决

上面的式子有两个问题要解决:

1. 这个式子有无限多项，如何求?
2. 式子里每一项都要用蒙特卡洛估计出一个值，那么就要对这段路径一次或多次采样，如何实现?

### 如何计算一个无限路径的累加值

用俄罗斯轮盘赌方法，按概率中断某个$p_i$点之后的计算，已计算的部分做加权处理，最终可以得到一个无偏的估计值

### 如何对某条路径进行多次采样，以便估计出值

从相机点开始，一段一段根据这一段BSDF贡献较大的方向构建出路径，最后一段固定是射到光源上。同时，由于原式里面的$p(\bar{p_n})$项是基于面的积分，要把它转换为基于立体角的积分
