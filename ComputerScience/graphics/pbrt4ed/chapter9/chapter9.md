# 9 反射模型

本章定义了一组类，用于描述光线在表面的散射过程。回顾4.3.1.我们介绍了双向反射分布函数(BRDF), BRDF抽象了光在表面的反射现象，BTDF(双向透射分布函数)用来描述表面上的透射现象，BSDF(双向散射分布函数)结合了前面两者的现象。在本章中，我们会从定义一个通用接口开始，来对表面反射和透射函数做接口化。

表面的反射模型来自于以下几个原因:

1. 已被测出的数据：很多现实中表面的反射分布属性已经在实验室中被测出。这些数据用表格形式列出，可以被直接使用，或者可以用一组基本函数计算出相关系数。
2. 现象学模型：用于描述现实世界中表面性质属性的公式，可以用于以假乱真的模拟它们。这种类型的BSDF特别容易被使用，虽然它们有一些靠直觉得出的参数，用于模拟某种表面的表现(比如 粗糙的)
3. 仿真模拟：有时，某种材质的组成在微观层面是已知的。例如：我们可能知道，油漆是由一些均等大小的，浮在介质中的带颜色的颗粒组成，或者某种特定的纤维，由两种已知反射率的线组成。在这种场景下，预处理可以模拟光在这种微结构下的表现，来满足某个近似的BSDF。另一种方式是，当渲染时再进行模拟。
4. 物理中的(波动)光学: 一些反射模型已经推导到光更精细的模型，把其视作波，然后用Maxwell的公式来计算结果，用来看再某种已知属性的表面上如何发生散射。主要使用在场景中包含了微观尺度下的几何细节的时候，比如在数字光学数据存储比如CD和DVD上的薄膜，图层和周期性结构上，这种方式让波动光学表现更加明显。
5. 几何光学： 于仿真方式一样，若表面在微观尺度上的散射和几何属性是已知的，那么从这些描述里有时就可以直接推导出一个闭合反射模型。几何光学让光与表面的交互过程的建模更加可跟踪，因此，波动效应比如衍射等的复杂性会被忽略。

> 闭合反射模型: 即此模型的项是有限的，且包含有限个标准运算(加减乘除，开根求幂等等)

本章会讨论由这些相关理论得来的各种模型的实现。也可参考14.3，那章介绍了基于在带层次的材质中的光的散射模拟。在本章末尾“扩展阅读”中，给出了各种额外的反射模型。

表面的外观其中一个重要的因素就是表面上反射和透射效应在空间中的变化量。第十章中的纹理和材质类会着重讲解这些问题，故在此章的抽象，只会考虑表面某点的散射效果。此外BRDF和BTDF只对光进入和离开表面时的散射效果建模。对于要表现带次表面的表面的光的传播，有一个更完善的模拟，这种模拟把光在材质里面的散射作用模拟出来了，这种方式时必要的，比如利用体积光线传播算法来达成，详见第14章

基本术语:

现在我们来介绍基本的术语，用于描述表面的反射现象。为了对比视觉上的表现结果，我们会分类为以下4个类型：漫反射(diffuse)，抛光(glossy)镜面，完美镜面,和逆反射。大部分真实的表面是由这四种表现混合起来的。漫反射表面均匀地在所有方向散射。虽然在物理上无法实现完美漫反射表面，比如近漫反射表面包括暗淡的黑板和哑光油漆。抛光表面比如塑料或者高光油漆，把光在某个反射方向上更多地散射出去，在其他方向上的反射，就看起来很模糊。完美镜面表面把入射光散射到一个方向。镜子和玻璃时完美镜面反射的粒子。最后，类似绒布，或者月亮这样的逆反射表面，把光主要以入射光相反的方向散射。下图展示了这四种情况的表现:

![图9.1](img/fg9_1.png)

图9.1 表面反射可以根据从入射方向到反射光方向的分布来归类:(a) 漫反射 (b) 抛光镜面 (c) 近完美镜面 (d) 逆反射

给出了反射的特定类型，反射分布函数可能是各向同性或各项异性的。对于各项同性的材质，若你在面上选择了一个点，然后把法线作为轴进行旋转，光的反射分布不会变。漫反射材质例如纸张和墙面油漆一般就是各向同性的，因为木头纤维或油漆颗粒在方向上是随机排列的。

反之，各向异性材质在沿着法线旋转时，反射不同数量的光。比如头发和各种布料。铣削、轧制、挤压和 3D 打印等工业过程也能生产高度各向异性的表面，一个极端的粒子就是拉丝的金属。

## 9.1 BSDF的表示

在pbrt中有两种对BSDF的表示组件，BxDF接口和它的实现类(在9.1.2章节描述)，和BSDF类(在9.1.5描述)。前者对表面的散射类型建模，后者对特定BxDF的实现做封装。
BSDF类也聚焦于让函数通用化，让BxDF的实现类不需要单独去操作，并且它记录了表面的局部的几何属性的信息。

### 9.1.1 几何上的设置和规则

在pbrt中的反射计算是在一个反射坐标系统中执行，这个坐标系统有2个垂直向量和法线向量，这三个向量分别与x,y,z对齐。所有方向的向量传给BxDF并从这里返回，BxDF会在相应的坐标系统中进行计算和采样。为了理解BxDF的实现，理解这个坐标系统是很重要的。

章节3.8介绍了一系列工具函数，比如SinTheta(), CosPhi()等，这些函数能高效地计算单位向量在匹配本章准则的笛卡尔坐标系下的三角函数。它们会在本章大量使用，比如在大部分反射模型中处于核心角色的仰角的余弦值。

![图9.2](img/fg9_2.png)

图9.2 基本的BSDF坐标系的设置。 这个着色坐标系统是由互相正交的基本向量$(\vec{s},\vec{t},\vec{n})$所定义。我们会让这些坐标与x,y,z轴对齐。在渲染空间中的方向向量$\omega$会在调用任何BRDF或BTDF前转换为着色坐标系的值。



### 9.1.2 BxDF接口

### 9.1.3 半球反射

### 9.1.4 BSDF的偏移分布

### 9.1.5 多种BSDF

## 9.2 漫反射

## 9.3 镜面反射和透射

## 9.4 导体的BRDF

## 9.5 电导体的BSDF

## 9.6 使用微表面理论测量粗糙度

## 9.7 粗糙的电导体的BSDF

## 9.8 Measured BSDFs

## 9.9 毛发的散射效果
