# 物理式渲染技术-理论与实现

- [物理式渲染技术-理论与实现](#物理式渲染技术-理论与实现)
  - [1 概述](#1-概述)
    - [1.1 阅读须知](#11-阅读须知)
    - [1.2 什么是渲染？](#12-什么是渲染)
    - [1.3 什么是物理式渲染(基于物理的渲染)?](#13-什么是物理式渲染基于物理的渲染)
    - [1.4 基于哪些物理学理论？](#14-基于哪些物理学理论)
    - [1.5 什么是光线追踪(ray tracing)](#15-什么是光线追踪ray-tracing)
    - [1.6 如何实现光线追踪？](#16-如何实现光线追踪)
  - [1.7 光线追踪种类(预删除：避免非重要内容概念列举)](#17-光线追踪种类预删除避免非重要内容概念列举)
  - [2 pbr的理论与实现](#2-pbr的理论与实现)
    - [2.1 现实中的观察过程抽象](#21-现实中的观察过程抽象)
    - [2.2 关键概念及联系](#22-关键概念及联系)
    - [2.3 系统宏观流程](#23-系统宏观流程)
    - [2.4 坐标系统](#24-坐标系统)
    - [2.5 模块](#25-模块)
      - [2.5.1 相机](#251-相机)
        - [2.5.1.1 镜片](#2511-镜片)
        - [2.5.1.2 胶片](#2512-胶片)
        - [2.5.1.3 感光器](#2513-感光器)
      - [2.5.2 物体](#252-物体)
        - [2.5.2.1 形状](#2521-形状)
        - [2.5.2.2 材质](#2522-材质)
        - [2.5.2.3 纹理](#2523-纹理)
        - [2.5.2.4 图元](#2524-图元)
      - [2.5.3 光](#253-光)
        - [2.5.3.1 BxDF](#2531-bxdf)
        - [2.5.3.2 光源](#2532-光源)
        - [2.5.3.3 介质](#2533-介质)
      - [2.5.4 采样器](#254-采样器)
      - [2.5.5 积分器](#255-积分器)
    - [2.6 其他功能](#26-其他功能)
      - [2.6.1 场景读取](#261-场景读取)
    - [2.7 运行效果(v1)](#27-运行效果v1)
  - [3 实时pbr](#3-实时pbr)
  - [4 进阶的pbr](#4-进阶的pbr)
  - [附录 I：理论简介](#附录-i理论简介)
  - [附录 II：参考资料](#附录-ii参考资料)


## 1 概述

本文会介绍物理式渲染技术(或称基于物理的渲染技术)的原理和实现。

本文预期读者(若有😂)为具有计算机程序开发能力，且对计算机图形渲染感兴趣的人。

本文偏重介绍理论和技术实践，尽量通俗易懂，相关理论在正文中会有简单介绍，有必要具体说明的在附录I中

本文不可避免在中后期会涉及诸多数学公式和物理量介绍，由于代码需要实现这些算法，想跳过公式是不可能的，代码实现难度也高，不是能够轻松完成的，请希望轻松体验的读者可以先考虑以RayTracingInOneWeek系列来入门

读完本文的读者，应该能了解物理式渲染的基础理论，并且实现物理式渲染，最终生成较为逼真的图像

文字尽量简单易懂。期望能在提高信息质量的同时，增加信息密度，减少阅读时间，降低理解难度，最终提高阅读效率和效果

本文预期是长期工程，目前尚未完成，但会尽量保证内容让读者有所收获，我会在更新过程中，不断修改完善

### 1.1 阅读须知

1. 阅读本文前，读者需要了解计算机图形学，C++，数学(微积分，线性代数)，若了解概率论统计学和物理学更佳
2. 由于物理式渲染涉及的知识横跨多个学科，为避免歧义，本文所有名词和相关解释，皆以计算机图形学为语境。
3. 写作不易，由于本人水平有限，若有错误，请直接联系我

### 1.2 什么是渲染？

用计算机程序把二维或三维模型的数据进行处理，并最终生成二维图像的过程。

动画的本质就是足够快且连续地播放这些渲染后的图像，让人眼看上去在动。

### 1.3 什么是物理式渲染(基于物理的渲染)?

物理式渲染(基于物理的渲染)(英文缩写为pbr(Physically Based Rendering))，主要目的是利用物理学理论，使渲染出来的图片跟照片一样真实。

而真实感的来源，最主要的一部分就是模拟现实中光的传播和与物体作用的过程。

### 1.4 基于哪些物理学理论？

严格来讲，pbr的实现其实并不完全遵循物理学理论，而是根据人眼对图像有限的分辨能力和计算机的有限的计算能力，在计算方法和方式上做了很多折衷，但是仍然可以说pbr在理念上是基于物理学的

本文所描述的pbr只是其理念的一种实现方式，这种pbr实现主要涉及的物理理论如下:

- **光学**：对应几何光学的部分理论，pbr用此理论描述光的传播和交互过程。
  - 在pbr中，假设光沿直线传播，并且忽略光的波动性，只考虑光的粒子性，主要关注光在真空或介质中传播现象，和光与不同物体之间的作用现象(比如散射，折射，反射等)。同时，一般来说，主要关注光的宏观尺度现象，忽略微观尺度现象
- **辐射度量学**: 由于光是电磁辐射的一种形式，pbr利用此学科用于衡量辐射能量在传播和与物体的作用的过程中，能量的变化情况。得到的各种物理量后续会被用来计算对应的颜色特征等数据
- **色度学**： 任何色彩的显示，实际上都是光刺激人类的视觉神经而产生的感觉，色度学研究光对应人眼的色彩的感知关系。pbr利用此学科来把辐射能转换为人类观察到的颜色特征
- **光度学**： 此学科描述光的各种物理特征。pbr利用此学科描述光的各种物理量

以上这些知识也会涉及到数学上的几何，线性代数，微积分，和概率论统计学知识。

本文讨论的pbr实现中，对这些物理相关理论的应用不深，读者只需了解高中物理知识，同时看得懂微积分公式即可。

关于计算机的成像原理，图形的描述，显示等相关知识请参考图形学书籍

### 1.5 什么是光线追踪(ray tracing)

**光线追踪**：用物理方法模拟光线传播和与一个或多个物体作用的过程的一种算法。在光线追踪的过程中会计算出光的多个相关的物理量。

对应的(软件或硬件)模块就叫做光线追踪器(ray tracer)

pbr目前几乎都是利用光线追踪器实现的。也就是说，光线追踪是pbr的一种技术实现方法。

### 1.6 如何实现光线追踪？

现实中拍摄照片或者人眼的观察，都是相机或人眼对观察的物体的光的信息进行了捕获和处理。要模拟真实情况，就可以根据在现实中观察或拍摄过程涉及到的事物和其联系进行概念抽象，利用面向对象的编程方法，转换为各种类

由于计算机性能有限且存在误差，需要对处理和计算过程做大量精简和优化。

一般来说，渲染的图片越真实，就需要更多的计算和处理，计算机的性能消耗就越大，渲染所需时间也越长。

> todo: 对现实中关键事物抽象及其联系进行介绍, 建模画图

## 1.7 光线追踪种类(预删除：避免非重要内容概念列举)

(1.7 光线追踪常识(物理规律光追做法介绍))

> todo 补图，需进一步完善

目前pbr都是几乎都是基于光线追踪算法实现的，光线追踪算法分为多种类型，这些类型后者都继承并扩展了前者，并解决了前者遇到的部分问题(也可能引入新的问题)，每种光追方法都是以经典方法为例,不考虑优化方法，如下:

1. 光线投射(Ray Casting):

    从相机向场景发射多条光线，经过图像的每个像素点后射入到场景中，检测光线与物体的交互，但通常只考虑表面的可见性，比如用来做遮挡检测，不处理反射、折射或阴影等复杂效果

    问题：渲染效果只能得到物体的形状和物体表面颜色，没有间接光照的效果。

    > 之所以要假设光线从人眼而不是更直观的光源出发，主要是为了避免计算不会落入相机中的光，大大降低计算量，以降低渲染时间，但是也会导致有些间接光效果模拟效果不好
2. whitted风格的光线追踪:

   在光线投射的基础上，考虑反射，折射，阴影等效果，由于漫反射材质不是直接反射或折射，漫反射之间的光模拟效果不佳

   问题： 漫反射物体之间的光的传播效果不真实

3. 分布式光线追踪(随机光线追踪)

    在whitted方法基础上，若光线碰到物体发生反射或折射等现象时，通过各种采样法生成多条光线，加上各种采样和效果处理后，效果更真实

    问题：由于光线碰到物体时生成新的光线，光线数量呈指数级上升，计算效率极低，渲染太慢，并且某些光照效果还是没法模拟
4. 路径追踪

   分布式光追的优化版，用蒙特卡罗方法，解决了whitted光追对于漫反射材质模拟的不足和计算量过大的问题

   问题：噪点，采样多渲染效果好，但是渲染速度也会变慢
5. 双向路径追踪

    在路径追踪的基础上，同时从光源和相机打出光线，若干次与物体碰撞后把路径连接起来，采用多重重要性采样，降低图像噪点

    问题：某些效果(如焦散效应)无法模拟，计算量大
6. 梅特波利斯光照传输(MLT)

    基于马尔科夫链，对光线中贡献大的路径进行采样。解决难以计算的特殊场景和复杂光照条件的问题。

    问题: 需要设计多种转移策略满足采样要求
7. 能量分布路径追踪(EPRT)

    基于能量分布进行采样,先像标准的路径追踪算法一样，使用蒙特卡罗的方法计算像素的颜色值，然后以一定的概率将能量（即某个像素的颜色）向周围流动
8. Manifold Exploration

    利用场景的光照特性，将采样集中在更有可能贡献光照的区域,提高光线追踪中的采样效率

## 2 pbr的理论与实现

本文v1版pbr是基于蒙特卡洛方法的路径追踪，以C++17面向对象的方式实现，主要用于离线渲染

代码采用递进式迭代方法，会从简单代码开始，逐步迭代到更复杂的代码。同时，前文的描述，会被后文所扩展

后期将逐步更新其他光线追踪算法实现和实时pbr相关内容

### 2.1 现实中的观察过程抽象

### 2.2 关键概念及联系

> todo 各个类和关系

### 2.3 系统宏观流程

> todo: 描述系统宏观流程

### 2.4 坐标系统

> todo: 介绍场景，坐标，空间，变换

### 2.5 模块

> todo: 涉及的物理原理和计算，类定义，关键函数，常见问题及解决方法，优化方案

#### 2.5.1 相机

##### 2.5.1.1 镜片

##### 2.5.1.2 胶片

##### 2.5.1.3 感光器

#### 2.5.2 物体

##### 2.5.2.1 形状

##### 2.5.2.2 材质

##### 2.5.2.3 纹理

##### 2.5.2.4 图元

#### 2.5.3 光

##### 2.5.3.1 BxDF

##### 2.5.3.2 光源

##### 2.5.3.3 介质

#### 2.5.4 采样器

#### 2.5.5 积分器

### 2.6 其他功能

#### 2.6.1 场景读取

### 2.7 运行效果(v1)

> 渲染后效果图

## 3 实时pbr

> todo: 未来可期

## 4 进阶的pbr

> todo: 未来可期

## 附录 I：理论简介

## 附录 II：参考资料

1. [Physically Based Rendering From Theory To Implementation 4ed](https://www.pbr-book.org/4ed/contents)
2. [erobert: ray-tracing](https://cs.stanford.edu/people/eroberts/courses/soco/projects/1997-98/ray-tracing/index.html)
3. [papalqi：光线追踪介绍](https://zhuanlan.zhihu.com/p/72673165)
4. [Wentao.Wang: pbr rendering](https://segmentfault.com/a/1190000000526976)
