# 物理式渲染技术-从新手到专家

## 1 概述

本文会以实践型学习方法：从新手到学徒，而不是从理论到实践的方法来介绍物理式渲染技术，相关理论会在实践中穿插，且深度会分阶段进行深入和更新

文章大概会以 新手 -> 学徒 -> 老手 -> 专家来区分理论和实践水平

本文预期读者(若有😂)为具有计算机程序开发能力，且对计算机图形渲染感兴趣的人。

本文到中后期是有难度的，请做好心理准备。希望轻松体验的读者可以先考虑以RayTracingInOneWeekend系列来入门

读完本文的读者，应该能了解物理式渲染的基础理论，并且实现物理式渲染，最终生成较为逼真的图像

文字尽量简单易懂。期望能在提高信息质量的同时，增加信息密度，减少阅读时间，降低理解难度，最终提高阅读效率和效果

本文预期是长期工程，目前尚未完成，但会尽量保证内容让读者有所收获，我会在更新过程中，不断修改完善

### 1.1 阅读须知

1. 阅读本文前，读者需要了解计算机图形学，C++，数学(微积分，线性代数)，若了解概率论统计学和物理学更佳
2. 由于物理式渲染涉及的知识横跨多个学科，为避免歧义，本文所有名词和相关解释，皆以计算机图形学为语境。
3. 写作不易，由于本人水平有限，若有错误，请直接联系我

### 1.2 什么是渲染？

用计算机程序把二维或三维模型的数据进行处理，并最终生成二维图像的过程。

动画的本质就是足够快且连续地播放这些渲染后的图像，让人眼看上去在动。

### 1.3 什么是基于物理的渲染?

基于物理的渲染(英文缩写为pbr(Physically Based Rendering))，主要目的是利用物理学理论，使渲染出来的图片跟照片一样真实。

而真实感的来源，最主要的一部分就是模拟现实中光的传播和与物体作用的过程。

### 1.4 基于哪些物理学理论？

严格来讲，pbr的实现其实并不完全遵循物理学理论，而是根据人眼对图像有限的分辨能力和计算机的有限的计算能力，在计算方法和方式上做了很多折衷，但是仍然可以说pbr在理念上是基于物理学的

本文所描述的pbr只是其理念的一种实现方式，这种pbr实现主要涉及的物理理论如下:

- **光学**：对应几何光学的部分理论，pbr用此理论描述光的传播和交互过程。
  - 在pbr中，假设光沿直线传播，并且忽略光的波动性，只考虑光的粒子性，主要关注光在真空或介质中传播现象，和光与不同物体之间的作用现象(比如散射，折射，反射等)。同时，一般来说，主要关注光的宏观尺度现象，忽略微观尺度现象
- **辐射度量学**: 由于光是电磁辐射的一种形式，pbr利用此学科用于衡量辐射能量在传播和与物体的作用的过程中，能量的变化情况。得到的各种物理量后续会被用来计算对应的颜色特征等数据
- **色度学**： 任何色彩的显示，实际上都是光刺激人类的视觉神经而产生的感觉，色度学研究光对应人眼的色彩的感知关系。pbr利用此学科来把辐射能转换为人类观察到的颜色特征
- **光度学**： 此学科描述光的各种物理特征。pbr利用此学科描述光的各种物理量

以上这些知识也会涉及到数学上的几何，线性代数，微积分，和概率论统计学知识。

本文讨论的pbr实现中，对这些物理相关理论的应用不深，读者只需了解高中物理知识，同时看得懂微积分方程，知道向量，矩阵的含义和基本计算规则即可。

关于计算机的成像原理，图形的描述，显示等相关知识请参考图形学书籍

### 1.5 什么是光线追踪(ray tracing)

**光线追踪**：用物理方法模拟光线传播和与一个或多个物体作用过程的一种算法。在光线追踪的过程中会计算出光的多个相关的物理量。

对应的(软件或硬件)模块就叫做光线追踪器(ray tracer)

pbr目前几乎都是利用光线追踪器实现的。也就是说，光线追踪是pbr的一种主要的，目前也是默认的技术实现方法。

### 1.6 如何实现光线追踪？

现实中拍摄照片或者人眼的观察，都是相机或人眼对观察的物体的光的信息进行了捕获和处理。要模拟真实情况，就可以根据在现实中观察或拍摄过程涉及到的事物和其联系进行概念抽象，利用面向对象的编程方法，转换为各种类，然后在这些类中做调用和计算，最终实现光线追踪。

由于计算机性能有限且存在误差，需要对处理和计算过程做大量精简和优化。

一般来说，渲染的图片越真实，就需要更多的计算和处理，计算机的性能消耗就越大，渲染所需时间也越长。

## 2 实现

## 2.1 入门级

### 2.1.1 建模

#### 关键对象

- 光线：用射线表示，当与物体碰撞时，发生某种作用
- 相机: 针孔相机，负责发射相机光线，并收集这些光线发射出去的结果
- 物体：有体积，光线会与其发生作用
- 图像: 用于记录光线的结果
- 像素: 在图像上阵列的n x m个无限小的点
- 颜色: 每个像素带着颜色信息，用红绿蓝三原色表示

#### 过程

1. 设定图像分辨率，并使其可计算处每个像素点的位置
2. 设定相机位置和离图像的距离，并对透视效果给出变换矩阵
3. 设定场景及其中包含的物体
4. 依次从每个像素点位置到相机位置连成射线，作为光线
5. 每射出一条光线，检查是否与场景中物体相交，若相交，给出一个颜色值，若未相交，返回另一个颜色值
6. 把每个像素的颜色给出后，在图像上输出这些像素的颜色，形成图片

#### 实现

## 2.3 学徒级

在入门级基础上，对光线相交改成反射，场景添加多个物体，物体是漫反射材质，有其反射率，光线可在物体间多次反射，颜色是由反射率求得

## 2.4 熟手级

导入渲染公式，BSDF，采样器，相机换成镜片相机并模拟畸变效果，材质包括多种漫反射，电导体等，加入光谱纹理，光线以光谱建模，颜色空间，基础光源

## 2.5 老手级

复杂模型，图像纹理，介质，颜色空间，感光元件，重要性采样，多光源，多线程异步优化，调试和日志功能

## 2.6 高手级

进阶路径追踪，光子映射，体渲染，GPU编程，神经网络渲染

1. [Physically Based Rendering From Theory To Implementation 4ed](https://www.pbr-book.org/4ed/contents)
2. [erobert: ray-tracing](https://cs.stanford.edu/people/eroberts/courses/soco/projects/1997-98/ray-tracing/index.html)
3. [papalqi：光线追踪介绍](https://zhuanlan.zhihu.com/p/72673165)
4. [Wentao.Wang: pbr rendering](https://segmentfault.com/a/1190000000526976)
