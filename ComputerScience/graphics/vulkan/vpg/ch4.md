# 第四章 数据的移动

图形和计算的操作一般来说是数据敏感的。Vulkan包含了一些对象，用来对这些数据进行存储和操作。把数据从这些对象里移出移进一般都是必要的，并且一些指令就是提供了这些操作的： 拷贝数据和填充缓冲和图像对象。此外，在某个给定的时间点，某个资源可能处于多个状态中的一种，并且Vulkan管线的许多部分可能需要访问这些资源。本章涵盖了数据的移动指令，这些指令可被用于拷贝数据和填充内存，同时，这些指令在被你的应用访问时，需要管理资源的状态

> 1. vulkan有一些对象，包含了一些指令，专门对数据进行操作
> 2. 资源会有多种状态，在使用指令时，需要对这些状态进行管理

## 管理资源状态

某个程序执行时的某个时间点，每个资源都可能使许多不同状态中的一种。比如，若图形管线正在绘制一个图像，或者这个管线被当作纹理数据的源，又或者vulkan正从宿主赋值数据到一个图像里，每个这些使用场景(的资源状态)都不同。对于某些vulkan的实现，可能实际上某些状态之间没有真正的区别，但是另一些，准确的知道资源在某个时间点的状态，决定了你的在应用是在工作还是只在渲染垃圾

> 1. 资源在执行不同的操作时，可能处于不同的状态
> 2. vulkan在不同的(硬件上的)实现中，某些状态可能没有区别
> 3. 弄清资源状态，才能知道应用实际的工作情况

由于在指令缓冲中的指令负责大多数资源的访问操作，并且由于指令缓冲可能是用不同顺序建立的，这个顺序基于执行时提交的顺序，实际上对于vulkan的实现来说，试图跟踪资源的状态，并保证在某个使用场景中是正确的，是不太现实的。特别是，某个资源可能开始于某个状态，然后由于某个指令缓冲的执行，切换到了另一个状态。虽然驱动能够根据某个指令缓冲跟踪资源的状态，但是当指令缓冲提交并执行指令时，在多个指令缓冲之间跟踪状态需要付出巨大的努力(比如验证层可以跟踪状态，但是会导致明显的性能影响)。因此，这个职责落到的你的应用上。资源的状态可能对于image来说是最重要的事情，因为它们本身是结构化的复杂资源

> 1. 指令缓冲在提交并执行指令时，会导致资源状态改变，由于指令提交是异步的，跟踪资源状态是麻烦的
> 2. 资源状态可通过开启验证层跟踪，但是影响性能，一般来说是由应用来控制和跟踪资源的状态，尤其对于某些资源，比如image，对状态的变化会比较敏感

一个image的状态可粗糙分为两种：layout(布局),用于决定数据在内存中的分布，这在前文已经简要介绍过，和一个最近一次写入image的操作者的记录，这个记录影响设备上数据的缓存和关联性。一个image的初始layout在创建时被指定，然后在此image的声明周期内可被修改，要么使用barrier来显式修改，或使用renderpass隐式修改。Barrier也会管理从不同Vulkan管线部分访问资源的顺序，并且在某些情况下，把某个资源的layout转成另一种的操作，可通过由barrier执行的管线中的同步工作里完成。

对于每个layout的特定使用案例会在后文详述。然而，资源状态的改变是barrier的基本行为。并且在你的应用中，对其正确和高效使用是极其重要的

> 1. image的状态可大致分为两部分：layout和最近操作者的记录
> 2. barrier用于显式修改一个资源的状态，对其正确高效使用非常重要

### 管线栅栏(barrier)

barrier是一种对内存访问管理的同步机制，并且可把资源的状态，在各个vulkan管线阶段内进行改变。用于对资源的访问做同步并且改变状态的主要指令是vkCmdPipelineBarrier()

barrier通过传入到commandBuffer来执行

vkCmdPipelineBarrier()可用于执行许多barrier相关的操作，有三类:全局内存barrier，缓冲barrier和image barrier。全局内存barrier会影响诸如对宿主和设备映射后的内存之间进行同步访问，缓冲和image barrier主要影响相应设备的缓冲和image资源的访问

### 全局内存barrier

...

内存barrier提供了两种重要功能，首先，它们帮助避免内存的指令重排(hazard)操作,其次，它们帮助确保数据的连续性。由于指令重排取决于平台和时效，出了问题难以排查。有三种hazard:

- 写后读（read-after-write）或叫RaW
- 读后写(write-after-read),或叫WaR
- 写后写(write-after-write),或叫WaW

没有读后读，因为数据没被变更

...

### 缓冲内存barrier

缓冲内存barrier提供了用于缓冲对象备份的内存的细粒度控制。

...

### image内存barrier

用于控制image的访问

...

## 缓冲的清除和填充

## image的清除和填充

## 拷贝image数据

## 拷贝压缩后的图像数据

## 拉伸图像