# 第13章重点总结

> **摘要**:
>
> 路径追踪计算式推导过程:
> 
> 1. 根据能量守恒假设，得出光传输方程LTE
> 2. 根据LTE，得出光线经过多个物体交点后，递归形式的LTE，做出一系列处理后，最终化为路径追踪方程
> 3. 路径追踪方程为求得其值，采用蒙特卡洛估计法
> 4. 用俄罗斯轮盘赌方法，减少上式中存在的递归项累加的计算，同时保持估计是无偏的
> 5. 从相机点开始，按顺序依次根据BSDF选取贡献量较大的方向采样点，减少采样计算量
> 6. 通过一些处理后，最终得到基于蒙特卡洛的路径追踪方程，及方程中每一项的计算公式

## 全局光照 VS 局部光照

全局光照要考虑物体自己的属性和相关其他物体的属性之间的光照效果，这样效果更接近真实。而局部光照只考虑单个物体自己的被光源光照射时的效果，计算简单，但是相对不太真实。

## 光传播方程(LTE)

此方程能给出光在场景中传播过程中，物体与光线相交时产生的辐射量，以便衡量明暗程度和计算交点处的最终颜色。

### LTE推导过程

LTE是基于能量守恒推导出来的，考虑一个整体系统，我们可以得到:

$$
输出的辐射功率 - 输入的辐射功率 = 发出的辐射功率 - 吸收的辐射功率
$$
对应到物体上，就是某个物体输入输出功率之差，与其发出与吸收功率之差相等，用公式表示，为
$$
\Phi_o - \Phi_i = \Phi_e - \Phi_a
$$
那么从功率到更加"纯粹"(即在功率的基础上，剥除方向和面积相关的量)描述辐射量的量，即Radiance(用L表示)，我们可以得到
$$
L_o-L_i=L_e-L_a
$$
可得到:
$$
L_o=L_e-L_a+L_i
$$
其中的$L_i-L_a$可以表示为$k \times L_i$，此处的k，可以用$BSDF \times \cos\theta$表示

那么得到物体表面一点，在立体角方向$\omega_o$出射的辐射量L,我们就可以得到LTE方程:

$$
 L_o(p, \omega_o) = L_e(p, \omega_o) + \int_{S^2}f(p, \omega_o,\omega_i)L_i(p,\omega_i)|\cos \theta_i|d\omega_i
$$

这里的$\cos\theta$加了绝对值是表示只考虑与法线方向同向的夹角的余弦值，避免负值,$f(p, \omega_o,\omega_i)$就是BSDF的函数，在$S^2$上积分代表考虑这个点所有方向上入射进来的辐射量的总和

这个方程右侧的两项里，有个$L_i$是未知的，如何求呢？

由能量守恒，我们可以知道，假设光传输过程无能量衰减(无介质)，要得到某点p的入射辐射量，可以找到入射方向$\omega$上，某物体表面交点p', p'的在$-\omega$方向上的输出辐射量

故我们可以把$L_i(p, \omega)$一项替换为$L_o(p', -\omega)$,其中p'用某种从p点到p'点变换$t(p,\omega)$表示，就可得到:

$$
 L(p, \omega_o) = L_e(p, \omega_o) + \int_{S^2}f(p, \omega_o,\omega_i)L(t(p, \omega), -\omega_i)|\cos \theta_i|d\omega_i
$$

由于L都只表示$L_o$，没有了$L_i$，故此处为了式子更简洁，省去L的下标。

推导到了此处，我们就只需要关注一个量，即$L_o$,其他量可看作已知的量。

### 把基于立体角积分的LTE，化为基于面积积分的LTE

原始LTE的求解，要对各个方向$\omega$做采样，不太方便，化为对面积采样，则更简单方便，故需要对LTE进行改造

我们定义，从p'到p的方向，用$p'\rightarrow p$表示。立体角$\omega$要化为面积，即$\frac{|\cos \theta'|}{r^2}$（其中$\theta'$代表p'处接收到的入射方向与法线的夹角，与LTE的$\theta$做区分），就可以把LTE化为:

$$
L(p' \rightarrow p) = L_e(p' \rightarrow p) + \int_A f(p'' \rightarrow p' \rightarrow p)L(p'' \rightarrow p')G(p'' \leftrightarrow p')dA(p'')
$$

其中p''即p'的上一个某物体上的交点，G函数是用原LTE里的$\vert\cos\theta\vert$与可视函数V(表示两个交点之间是否有阻挡，1为无阻挡,0为阻挡)和立体角到面的转换方程的乘积合成出来的函数,如下式:

$$
G(p \leftrightarrow p') = V(p \leftrightarrow p')\frac{\vert\cos \theta\vert\vert\cos \theta'\vert}{\Vert p-p'\Vert^2}
$$

### 把基于面积积分的LTE，化为基于光传播路径的积分式

我们刚刚推导出了LTE在面上的积分形式，但是从光源到最终入射到相机的光传播过程，可能有n次($n \geq 0$)与物体相交过程，若直接使用这个LTE，会导致式子的递归，不好计算，故我们需要推导对于光线传播路径上的LTE

假设某条光线路径经过多个交点，最终入射到相机中，那么我们根据LTE，把LTE的积分里的被积函数L，替换为它自己的LTE，那么这个式子就是递归的，我们把这个递归式拆开，可以得到一大串积分式相加的式子，每个积分式我们称为$P(\bar{p}_n)$,这里的n代表到相机点的第n个交点，注意，式子里有一项是$p_1$的$L_e$这一项虽然没有积分，我们也看成$P(\bar{p}_n)$

把相机点看作$p_0$点，光源点看作$p_n$点(n等于这条路径中间交点的次数+1)，

更形象一些，可以参考下图：

![图13.3](img/fg13_3.png)

此图假设光源到相机点经过了2个顶点，故n=3

把这个对面积的LTE的递归式子拆开后，我们注意到积分中的BSDF和G函数项，像滚雪球一样随着离相机点越远，滚得越多，我们把这一大坨式子看成$T(\bar{p}_n)$,用来代表光线路径的吞吐量。

最终我们就可以用下式代表某点入射到相机点$p_0$的辐射量:

$$
L(p_1 \rightarrow p_0)=\sum_{n=1}^\infty P(\bar{p}_n)
$$

每一项$P(\bar{p}_n)$都是一个积分，就可以用蒙特卡洛估计法来估计了,故可以把上式化为:

$$
L(p_1 \rightarrow p_0) \approx \sum_{n=1}^{\infty}\frac{P(\bar{\mathsf{p}}_n)}{p(\bar{\mathsf{p}}_n)}
$$

分母p函数，就是此点的概率密度函数(PDF)

### delta分布

待补充

### 拆分路径积分式中的被积函数

路径积分式是由各条路径的$P(\bar{\mathsf{p}_n})$累加组成的，里面的每一项，可以用不同的方法得到，有时候会根据需求，拆开此式后用不同采样方法计算，可能更方便

## 路径追踪

之前用LTE推导出了路径上的辐射量计算公式，现在有两个问题需要考虑:

1. 这个式子有无限多项，如何求呢？
2. 式子里每一项都是一个积分，若用蒙特卡洛估计，那么就要对每个$P(\bar{\mathsf{p}_n})$多次采样，如何实现呢?

### 求解无限多项的方法

用俄罗斯轮盘赌方法(详见第二章)，使路径追踪公式只按1-q概率计算每一项的值

若我们以q的概率停止计算某$P(\bar{\mathsf{p}_n})$项，那么路径积分式就变为下面的形式:

$$
\frac{1}{1-q_1}(P(\bar{\mathsf{p}}_1)+\frac{1}{1-q_2}(P(\bar{\mathsf{p}}_2)+\frac{1}{1-q_3}(P(\bar{\mathsf{p}}_3)+...
$$

对于前面的几项，若实际已经计算了，则就会对计算过的项做适当加权，这样最终估计值就是无偏的

### 估计每个$P(\bar{\mathsf{p}_n})$的方法

每项$P(\bar{\mathsf{p}_n})$，就是在$p_{n}$点所在的面上，采样一个点，作为光传播路径上的交点，其中$p_0$点是相机点。若采用均匀分布采样(即所有点采样概率相同)，那么每个点的采样概率即为场景中所有物体的面积的和的倒数。如果$p_n$也是在这些面上均匀随机采样，则会导致估计值收敛极慢(因为正常来说，对于$p_n$是在场景随机面上采样某点，这种没有光源参与的路径下，辐射贡献量为0)。因此,$p_n$固定在光源上采样会更好，但是要对概率做加权处理，以便加快估计式的收敛速度，减轻计算量。

加权多少就比较灵活了，比如某个光源对场景的光照贡献量比较大，那么权值就可以比较大，路径采样时，就容易采样到这个光源所在的路径。

但是这种方法又会带来两个问题:

1. 估计式有高方差
2. 某些情况下，结果不正确

第一个问题原因在于，当采样的路径中，有两个相邻顶点互不可见(被遮挡)时，许多路径会实际上没有光辐射贡献量，这会带来高方差。

第二个问题与delta分布有关，原因待补充

### 解决这两个问题的方法

从相机点开始，按顺序，一个顶点一个顶点的找，而不是像前文所述那样一次找出所有点。从每个顶点选取下一个顶点的方向的方法，是根据这个点的BSDF，对这个顶点的贡献量较大的方向给予更高的概率来选取。最终得出的整条路径，就是光辐射贡献量较大的路径。虽然此方法有时会无效(因为顶点贡献度高的路径，通常是，但未必是实际总体贡献度高的路径)，但是总体来说是有效的。

由于基于BSDF采样方向的方式是基于立体角的，但是之前得到的路径追踪LTE式子是基于面积积分的，所以要对BSDF的概率密度做一下修正，设BSDF中，入射方向的概率密度为$p_w$，修正后的面的概率密度为$p_A$，且$\omega_{i-1}$是$p_{i-1}$归一化的向量:

$$
p_A(\mathsf{p_i})= p_\omega(\omega_{i-1})\frac{\vert\cos\theta_i\vert}{\Vert \mathsf{p_{i-1}-p_i}\Vert ^2}
$$

这个式子代入到路径追踪的蒙特卡洛估计式，作为分母，可以抵消掉G函数里面除了$\cos\theta_{i+1}$以外的项。同时，由于已经采样了$p_i$,故已假设$p_{i-1}\rightarrow p_i$是可见的，即V函数总是为1。换个角度来看，就可以说此采样方法是关于G函数做了重要性采样。

最后光源上的$p_n$点要特殊对待，以$p_e$的概率密度来采样

通过此式，与路径追踪LTE公式对应的蒙特卡洛估计式联立，就可得到:

$$
P(\bar{p}_i)\approx \frac{L_e(\mathsf{p_i} \rightarrow \mathsf{p_{i-1}})f(\mathsf{p_i}\rightarrow \mathsf{p_{i-1}} \rightarrow \mathsf{p_{i-2}})G(\mathsf{p_i} \leftrightarrow \mathsf{p_{i-1}})}{p_e(\mathsf{p_i})}\\
\times \bigg(\prod_{j=1}^{i-2}\frac{f(\mathsf{p_{j+1}} \rightarrow \mathsf{p_{j}} \rightarrow \mathsf{p_{j-1}})\vert\cos\theta_j\vert}{p_\omega(\omega_j)}\bigg)
$$

这个式子中，除了光源点$p_n$外，第m个点的值重复利用了m-1个点的值，造成了关联性，可能会影响蒙特卡洛估计准确度。若要路径的选取完全独立，就需要更多的路径采样，不太划算。此方法由于减少了路径采样数，能大幅提升计算效率，这么取舍还是值得的。
