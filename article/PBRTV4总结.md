# 基于物理的渲染第四版导读

本书阅读目标我认为至少应该可以独立写出PBR路径追踪软渲染器

重点章节应该是4，5，13；

次重点是8,9,10,12

其他的按需选读

以下是一些高度总结的内容，需要参考可以看我个人的总结笔记

## PBR 和 PBRT

PBR即基于物理的渲染，PBRT就是本书附赠的项目名，即基于物理渲染的工具包，这个系统主要是一个离线PBR渲染器，支持CPU和GPU渲染，其实稍加扩展也可实现动画。

## 光线追踪

光线追踪是PBR中全局光照的实现方法，具体来说是路径追踪

## 渲染方程

又叫光传输方程(LTE)，非常重要，贯穿全书,用来计算光线追踪过程中与光线相关的量，以便最后根据这些量转换为像素的颜色

$$
L_o(p, \omega_o) = L_e(p, \omega_o) + \int_{S^2}f(p, \omega_o,\omega_i)L_i(p,\omega_i)|\cos \theta_i|d\omega_i
$$

上式是说，空间中某点的光辐射量，就是这个点自身发出的光辐射量，加上四面八方射到这个点上的光的辐射量。先理解到此即可，若看不懂公式后面会补充

## PBR涉及学科

物理学上，主要涉及:

- 几何光学: 现实中的光具有波粒二象性，这里只考虑粒子性，且把光看成一条射线，这条射线携带者光的能量，碰到物体就会导致光线方向和能量改变
- 辐射度学：把光看成电磁辐射，这种辐射具有波长和能量，主要用于描述光的能量和能量的变化，以便计算完以后根据这些能量转换为对应的颜色
- 光度学： 光的能量最终会被人眼接收到，看到什么颜色如何定义，就是基于光度学，辐射度学和光度学的物理量，通过一些方法可以相互转化
- 色度学： 色彩如何定义，就根据这门学科
- 信号与处理：采样，反走样，图像重建的原理和方法

数学上，主要涉及:

- 微积分: 用于描述物理建模的方程
- 线性代数: 描述几何变换
- 几何: 描述物体形状特征和变化，相交计算等
- 概率与统计：积分求解，图像质量优化，性能优化的基础

## 相机和成像

Camera通过shutter成员控制相机快门开关，通过lens定义和控制镜片大小和镜片效果，通过Film类成像，Film类里包括PixelSensor模拟相机的感光效应，还有Filter用来为像素点接收到的光的辐射量模拟成像比。Film输出图像是用Image类，色彩编码和转换是用Color和ColorEncoding类完成

## 物体和图元

shape类定义物体几何特征和求交操作，Primitive类包含Shape和Material类，同时也负责生成包围盒。注意求交时的点涉及到的数据和操作是在Interaction类里

## 采样和图像重建

Sampler类定义采样方法，Filter类实现滤波函数

## BSDF，材质，纹理

主要是通过Material类实现材质，这个类里有Texture类，纹理根据某个TextureEvaluator计算出纹理坐标，由Texture下的evaluate()给出纹理值，BSDF是由Material给出的，用于LTE计算。

Texture分为FloatTexture和SpectrumTexture，前者用于支持位移贴图，粗糙度等特性，后者用于定义按光谱量计算的纹理

## 光源和光源采样器

对应Light接口，光源采样器对应LightSampler

## LTE和路径追踪

LTE是由能量守恒推导出来的，LTE递归出路径追踪方程，此方程含有的积分是由蒙特卡洛积分估计出来的。路径追踪主要涉及到多重重要性采样，俄罗斯轮盘赌和路径正则化方法优化性能和图像质量

## 代码优化

此书附赠代码极有学习价值，而且直接可以运行，指令参数都定义好了，还有场景可以跑，debug和log也是有的

1. 用了TaggedPointer定义了指针，主要为了消除C++虚函数的虚表内存消耗，同时也方便支持GPU调用和CPU用同一套程序
2. 计算方面预定了一些常用值，幂计算用了查表法
3. 做了缓存，主要是光谱分布的数据
4. 用了内存分配器提高性能
5. 随机数生成时作者自己写的，基于pcg256
6. 自实现线性代数计算
7. 自实现多线程和异步工具
8. 有个pbrt-v4-scene可以实验场景渲染